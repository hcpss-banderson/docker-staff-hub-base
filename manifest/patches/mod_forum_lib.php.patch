# This patch file was generated by NetBeans IDE
# It uses platform neutral UTF-8 encoding and \n newlines.
--- HEAD
+++ Modified In Working Tree
@@ -587,8 +587,6 @@
             // Terminate if processing of any account takes longer than 2 minutes.
             core_php_time_limit::raise(120);
 
-            mtrace('Processing user ' . $userto->id);
-
             // Init user caches - we keep the cache for one cycle only, otherwise it could consume too much memory.
             if (isset($userto->username)) {
                 $userto = clone($userto);
@@ -603,6 +601,10 @@
             // Setup this user so that the capabilities are cached, and environment matches receiving user.
             cron_setup_user($userto);
 
+            // HCPSS Mod add logging
+            mtrace('Environment set max_time '.ini_get("max_execution_time"));
+            // End HCPSS Mod
+            
             // Reset the caches.
             foreach ($coursemodules as $forumid => $unused) {
                 $coursemodules[$forumid]->cache       = new stdClass();
@@ -610,6 +612,10 @@
                 unset($coursemodules[$forumid]->uservisible);
             }
 
+            // HCPSS Mod add logging
+            mtrace('Caches reset max_time '.ini_get("max_execution_time"));
+            // End HCPSS Mod
+
             foreach ($posts as $pid => $post) {
                 $discussion = $discussions[$post->discussion];
                 $forum      = $forums[$discussion->forum];
@@ -671,6 +677,10 @@
                 // Setup global $COURSE properly - needed for roles and languages.
                 cron_setup_user($userto, $course);
 
+                // HCPSS Mod add logging
+                mtrace('Global course set max_time '.ini_get("max_execution_time"));
+                // End HCPSS Mod
+
                 // Fill caches.
                 if (!isset($userto->viewfullnames[$forum->id])) {
                     $modcontext = context_module::instance($cm->id);
@@ -693,6 +703,10 @@
                     }
                 }
 
+                // HCPSS Mod add logging
+                mtrace('Caches filled max_time '.ini_get("max_execution_time"));
+                // End HCPSS Mod add logging
+
                 // Make sure groups allow this user to see this email.
                 if ($discussion->groupid > 0 and $groupmode = groups_get_activity_groupmode($cm, $course)) {
                     // Groups are being used.
@@ -726,6 +740,11 @@
                     $queue->postid       = $post->id;
                     $queue->timemodified = $post->created;
                     $DB->insert_record('forum_queue', $queue);
+                    
+                    // HCPSS Mod add logging
+                    mtrace('Sending '.'post '.$post->id. ': '.$post->subject.' to digest');
+                    // End HCPSS Mod
+                    
                     continue;
                 }
 
@@ -772,6 +791,10 @@
                 $posthtml = forum_make_mail_html($course, $cm, $forum, $discussion, $post, $userfrom, $userto,
                         $replyaddress);
 
+                // HCPSS Mod add logging
+                mtrace('Post content built max_time '.ini_get("max_execution_time"));
+                // End HCPSS Mod add logging
+
                 // Send the post now!
                 mtrace('Sending ', '');
 
@@ -970,10 +993,51 @@
                     $posthtml .= '<link rel="stylesheet" type="text/css" href="'.$stylesheet.'" />'."\n";
                 }*/
                 $posthtml .= "</head>\n<body id=\"email\">\n";
-                $posthtml .= '<p>'.get_string('digestmailheader', 'forum', $headerdata).'</p><br /><hr size="1" noshade="noshade" />';
+                // HCPSS Mod Increase hr size to 3
+                $posthtml .= '<p>'.get_string('digestmailheader', 'forum', $headerdata).'</p><br /><hr size="3" noshade="noshade" />';
+                // End HCPSS Mod
 
+                // (Shirai170): Sorting discussion topics in digest mail (2009/10/01) HCPSS Mod
+                if (count($thesediscussions) >= 3) {
+                    // array: Coursed ID, Forum ID, Discsussion topics ID
+                    $cfd = array();
                 foreach ($thesediscussions as $discussionid) {
+                        $discussion = $discussions[$discussionid];
+                        $forum = $forums[$discussion->forum];
+                        $course = $courses[$forum->course];
+                        //if idnumber is defined pad it in there else use a bunch of 9's to put it at the bottom
+                        $coursesort = ($course->idnumber == '' or !($course->idnumber)) ? 99999999 : $course->idnumber;
+                        $coursesort = str_pad($coursesort, 8, '0', STR_PAD_LEFT).str_pad($course->id, 8, '0', STR_PAD_LEFT);
+                        //get the forum module and if idnumber is defined pad it in there else use a bunch of 9's to put it at the bottom
+                        //$forummodule = $DB->get_record('course_modules', array('instance' => $forum->id));
+                        $forummodules = $DB->get_records('course_modules', array('instance' => $forum->id));
+                        $forummodule = current($forummodules);
+                        foreach($forummodules as $this_forummodule){
+                            if(!($forummodule->idnumber == '' or !($forummodule->idnumber))){
+                                $forummodule = $this_forummodule;
+                            }
+                        }
+                        $forumsort = ($forummodule->idnumber == '' or !($forummodule->idnumber)) ? 99999999 : $forummodule->idnumber;
+                        $forumsort = str_pad($forumsort, 8, '0', STR_PAD_LEFT).str_pad($forum->id, 8, '0', STR_PAD_LEFT);
+                        $cfd[$coursesort][$forumsort][$discussionid] = $discussionid;
+                    }
+                    // Sort by key
+                    $thesediscussions = array();
+                    ksort($cfd);
+                    foreach ($cfd as $cfd_forums) {
+                        ksort($cfd_forums);
+                        foreach ($cfd_forums as $cfd_discussions) {
+                            ksort($cfd_discussions);
+                            foreach ($cfd_discussions as $cfd_discussion) {
+                                $thesediscussions[$cfd_discussion] = $cfd_discussion;
+                            }
+                        }
+                    }
+                }
+                // (Shirai170): Add to here
 
+                foreach ($thesediscussions as $discussionid) {
+
                     core_php_time_limit::raise(120);   // to be reset for each post
 
                     $discussion = $discussions[$discussionid];
@@ -1010,16 +1074,24 @@
                     $posttext .= $CFG->wwwroot.'/mod/forum/discuss.php?d='.$discussion->id;
                     $posttext .= "\n";
 
+                    //HCPSS Mod to seperate courses
+                    if(isset($prior_course) and ($prior_course->id != $course->id)){
+                        $posthtml .= '<hr size="6" noshade="noshade" color="#00B25D" />';
+                    }
+                    //End HCPSS Mod
+
                     $posthtml .= "<p><font face=\"sans-serif\">".
-                    "<a target=\"_blank\" href=\"$CFG->wwwroot/course/view.php?id=$course->id\">$shortname</a> -> ".
-                    "<a target=\"_blank\" href=\"$CFG->wwwroot/mod/forum/index.php?id=$course->id\">$strforums</a> -> ".
+                    //HCPSS Mod: Replaced -> with &#8226, &#58; and added H3 to post title
+                    "<a target=\"_blank\" href=\"$CFG->wwwroot/course/view.php?id=$course->id\">$shortname</a> &#8226; ".
+                    "<a target=\"_blank\" href=\"$CFG->wwwroot/mod/forum/index.php?id=$course->id\">$strforums</a> &#8226; ".
                     "<a target=\"_blank\" href=\"$CFG->wwwroot/mod/forum/view.php?f=$forum->id\">".format_string($forum->name,true)."</a>";
                     if ($discussion->name == $forum->name) {
                         $posthtml .= "</font></p>";
                     } else {
-                        $posthtml .= " -> <a target=\"_blank\" href=\"$CFG->wwwroot/mod/forum/discuss.php?d=$discussion->id\">".format_string($discussion->name,true)."</a></font></p>";
+                        $posthtml .= " &#58;<h3><a target=\"_blank\" href=\"$CFG->wwwroot/mod/forum/discuss.php?d=$discussion->id\">".format_string($discussion->name,true)."</a></font></h3></p>";
                     }
                     $posthtml .= '<p>';
+                    //End HCPSS Mod
 
                     $postsarray = $discussionposts[$discussionid];
                     sort($postsarray);
@@ -1078,7 +1150,9 @@
                             $posttext .= "\n---------------------------------------------------------------------";
 
                             $by->name = "<a target=\"_blank\" href=\"$CFG->wwwroot/user/view.php?id=$userfrom->id&amp;course=$course->id\">$by->name</a>";
-                            $posthtml .= '<div><a target="_blank" href="'.$CFG->wwwroot.'/mod/forum/discuss.php?d='.$discussion->id.'#p'.$post->id.'">'.format_string($post->subject,true).'</a> '.get_string("bynameondate", "forum", $by).'</div>';
+                            // HCPSS Mod Remove subject
+                            $posthtml .= '<div>'.get_string("bynameondate", "forum", $by).'</div>';
+                            // End HCPSS Mod
 
                         } else {
                             // The full treatment
@@ -1099,7 +1173,10 @@
                     }
                     $footerlinks[] = "<a href='{$CFG->wwwroot}/mod/forum/index.php?id={$forum->course}'>" . get_string("digestmailpost", "forum") . '</a>';
                     $posthtml .= "\n<div class='mdl-right'><font size=\"1\">" . implode('&nbsp;', $footerlinks) . '</font></div>';
-                    $posthtml .= '<hr size="1" noshade="noshade" /></p>';
+                    // HCPSS Mod Increase hr size to 3 and set prior course
+                    $posthtml .= '<hr size="3" noshade="noshade" /></p>';
+                    $prior_course = $course;
+                    // End HCPSS Mod
                 }
                 $posthtml .= '</body>';
 
@@ -1292,9 +1369,11 @@
     $posthtml .= "\n<body id=\"email\">\n\n";
 
     $posthtml .= '<div class="navbar">'.
-    '<a target="_blank" href="'.$CFG->wwwroot.'/course/view.php?id='.$course->id.'">'.$shortname.'</a> &raquo; '.
-    '<a target="_blank" href="'.$CFG->wwwroot.'/mod/forum/index.php?id='.$course->id.'">'.$strforums.'</a> &raquo; '.
+    // HCPSS Mod: Replaced &raquo; with &#8226;, and added &#58;H3 to post title
+    '<a target="_blank" href="'.$CFG->wwwroot.'/course/view.php?id='.$course->id.'">'.$shortname.'</a> &#8226; '.
+    '<a target="_blank" href="'.$CFG->wwwroot.'/mod/forum/index.php?id='.$course->id.'">'.$strforums.'</a> &#8226; '.
     '<a target="_blank" href="'.$CFG->wwwroot.'/mod/forum/view.php?f='.$forum->id.'">'.format_string($forum->name,true).'</a>';
+    // End HCPSS Mod
     if ($discussion->name == $forum->name) {
         $posthtml .= '</div>';
     } else {
